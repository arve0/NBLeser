"use strict";var ApplicationConfiguration=function(){var applicationModuleName="nbleser",applicationModuleVendorDependencies=["ngResource","ipCookie","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","chieffancypants.loadingBar"],registerModule=function(moduleName){angular.module(moduleName,[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("leser"),ApplicationConfiguration.registerModule("search"),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Menus","$anchorScroll","$location","$modal","ReaderControls",function($scope,Menus,$anchorScroll,$location,$modal,ReaderControls){$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.controls=ReaderControls;var modalInstance;$scope.showTerms=function(){modalInstance=$modal.open({templateUrl:"/modules/core/views/terms.client.view.html",scope:$scope})},$scope.closeTerms=function(){modalInstance.close()}}]),angular.module("core").controller("HomeController",["$scope","$location","$rootScope","$http","Search","$modal","ReaderControls","$window",function($scope,$location,$rootScope,$http,Search,$modal,ReaderControls,$window){var modalInstance;ReaderControls.show=!1,$window.document.title="NBLeser - les over 170-tusen gratis ebøker fra Nasjonalbiblioteket",$rootScope.geoChecked||$http.get("/geoip").success(function(geoip){geoip.error&&console.log(geoip.error),"NO"!==geoip.country&&(modalInstance=$modal.open({templateUrl:"/modules/core/views/norwegian-modal.client.view.html",scope:$scope})),$rootScope.geoChecked=!0}),$scope.closeModal=function(){modalInstance.close()},$scope.search=function(query){$location.url("/search/"+query)},$scope.readFirstHit=function(query){$scope.error=!1;var searchPromise=Search.get(query);searchPromise.then(function(data){var urn=data.entry[0]["nb:urn"].$t;$location.url("/leser/"+urn)},function(err){$scope.error=err})},$scope.read=function(urn){$location.url("/leser/"+urn)}}]),angular.module("core").directive("focusMe",["$timeout",function($timeout){return{link:function(scope,element){$timeout(function(){element[0].focus()},500)}}}]),angular.module("core").directive("history",["$window",function($window){return{link:function(scope,element,attrs){"forward"===attrs.history?(element.addClass("glyphicon glyphicon-chevron-right history"),element.on("click",function(){$window.history.forward()})):(element.addClass("glyphicon glyphicon-chevron-left history"),element.on("click",function(){$window.history.back()}))}}}]),angular.module("core").service("Menus",function(){this.menus={},this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId){return this.menus[menuId]={items:[]},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemUIRoute){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL}),this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}),angular.module("leser").config(["$stateProvider",function($stateProvider){$stateProvider.state("leser",{url:"/leser/:urn",templateUrl:"modules/leser/views/leser.client.view.html"})}]),angular.module("leser").controller("LeserController",["$scope","$rootScope","Tilemap","$document","$stateParams","$location","ReaderControls","$timeout","Search","$window",function($scope,$rootScope,Tilemap,$document,$stateParams,$location,ReaderControls,$timeout,Search,$window){$rootScope.error="";var urn=$stateParams.urn,searchPromise=Search.get("urn:"+urn);searchPromise.then(function(data){$window.document.title=data.entry[0].title}),$scope.controls=ReaderControls,$scope.controls.show=!0,$scope.scrollTop=0,$document.on("scroll",function(){if($scope.scrollTop=window.pageYOffset,$scope.pages)for(var i=0;i<$scope.pages.length;i++)if($scope.scrollTop<$scope.pages[i].offsetTop){$scope.controls.currentPage=$scope.controls.pageList[i-1];break}$rootScope.$digest()}),$document.on("touchstart",function(){$scope.scrollTop=window.pageYOffset,$scope.$digest()});var tilemapPromise=Tilemap.getPages(urn);tilemapPromise.then(function(pages){$scope.pages=pages,$scope.controls.pages=pages.length,$scope.controls.firstRun=!0,$scope.controls.levels=pages.getNumberOfLevels(),$scope.pages.updateLevel($scope.controls.level),$scope.$watch("controls.level",function(level){$scope.pages.updateLevel(level)}),$timeout(function(){var page=$location.hash().replace(/^p/,"");page&&($scope.controls.currentPage=$scope.controls.pageList[page-1],$scope.controls.goto())})},function(error){$rootScope.error=error,$location.url("/")})}]),angular.module("leser").directive("bookWidth",function(){return{link:function(scope,element,attrs){var width=scope.$eval(attrs.bookWidth);element.css("width",width+"%"),scope.$watch(attrs.bookWidth,function(value){width=value,element.css("width",width+"%")})}}}),angular.module("leser").directive("pageHeight",["$timeout","$document","$window",function($timeout,$document,$window){var _position=0,_windowHeight=$window.innerHeight,_windowWidth=$window.innerWidth;return{link:function(scope,element,attrs){function setHeight(){if(scope.page.currentLevel){var realWidth=_windowWidth*scope.$eval(attrs.zoom)/100,sourceWidth=scope.page.currentLevel.width,scale=realWidth/sourceWidth,height=Math.ceil(scope.page.currentLevel.height*scale);element.css("height",height+"px"),scope.page.offsetTop=_position,_position+=height,scope.page.offsetBottom=_position}}scope.$watch(attrs.zoom,function(){0===scope.$index&&(_position=0),setHeight()}),angular.element($window).on("resize",function(){0===scope.$index&&(_position=0),_windowHeight=$window.innerHeight,_windowWidth=$window.innerWidth,setHeight()})}}}]),angular.module("leser").directive("scaleImage",function(){return{link:function(scope,element){var scale;scope.$last&&(scale=scope.page.currentLevel.lastColumnScale,element.css("-webkit-box-flex",scale),element.css("-moz-box-flex",scale),element.css("-ms-box-flex",scale),element.css("box-flex",scale),element.css("-webkit-flex",scale),element.css("-ms-flex",scale),element.css("flex",scale))}}}),angular.module("leser").directive("scaleRow",function(){return{link:function(scope,element){var scale;scope.$last&&(scale=scope.page.currentLevel.lastRowScale,element.css("-webkit-box-flex",scale),element.css("-moz-box-flex",scale),element.css("-ms-box-flex",scale),element.css("box-flex",scale),element.css("-webkit-flex",scale),element.css("-ms-flex",scale),element.css("flex",scale))}}}),angular.module("leser").factory("ReaderControls",["$location","$anchorScroll","$modal","ipCookie","$window","$rootScope","$timeout",function($location,$anchorScroll,$modal,ipCookie,$window,$rootScope,$timeout){for(var _zoomValues=[],i=10;101>i;i+=10)_zoomValues.push({value:i,text:i+"%"});var _windowHeight=$window.innerHeight,_pageList=[1],_controls={pages:1,pageList:_pageList,currentPage:_pageList[0],firstRun:!0,level:ipCookie("level")||5,levels:6,levelList:[0,1,2,3,4,5],show:!1,zoomValues:_zoomValues,zoom:ipCookie("zoom")||100,"goto":function(){var id="p"+this.currentPage;if(document.getElementById(id))$location.hash(id),$timeout($anchorScroll);else{$modal.open({template:'<div class="alert alert-danger">Finner ikke siden.</div>'})}},showPage:function(windowPageYOffset,elementTopOffset,elementBottomOffset){return Math.abs(windowPageYOffset-elementTopOffset)>5e3?!1:Math.abs(windowPageYOffset-elementTopOffset)<_windowHeight||Math.abs(windowPageYOffset-elementBottomOffset)<_windowHeight||0>elementTopOffset-windowPageYOffset&&0>windowPageYOffset+_windowHeight-elementBottomOffset}};return $rootScope.$watch(function(){return _controls.level},function(newValue){ipCookie("level",newValue,{expires:365})}),$rootScope.$watch(function(){return _controls.zoom},function(newValue){ipCookie("zoom",newValue,{expires:365})}),$rootScope.$watch(function(){return _controls.pages},function(pages,oldValue){if(pages!==oldValue){_pageList=[];for(var i=1;pages>=i;i++)_pageList.push(i);_controls.pageList=_pageList,_controls.currentPage=_pageList[0]}}),$rootScope.$watch(function(){return _controls.levels},function(levels,oldValue){if(levels!==oldValue){_controls.levelList=[];for(var i=0;levels>i;i++)_controls.levelList.push(i);levels-1<_controls.level&&(_controls.level=levels-1)}}),_controls}]),angular.module("leser").factory("Tilemap",["$http","$timeout","$q",function($http,$timeout,$q){function createImageArray(level,templateUrl){for(var i=0;i<level.rows;i++){level.images.push([]);for(var j=0;j<level.columns;j++){var url=templateUrl.replace("{row}",i).replace("{column}",j);level.images[i].push(url)}}return level}function processLevels(levels,pageIndex){for(var i=0;i<levels.length;i++){var level=levels[i],templateUrl=level.uri.template;level.images=[];var pixels,tileHeight=_pages[pageIndex].tileMap.tileHeight,tileWidth=_pages[pageIndex].tileMap.tileWidth;level.height>tileHeight&&(pixels=level.height-(level.rows-1)*tileHeight,level.lastRowScale=pixels/tileHeight),level.width>tileWidth&&(pixels=level.width-(level.columns-1)*tileWidth,level.lastColumnScale=pixels/tileWidth),level=createImageArray(level,templateUrl)}return levels}var _pages,updateLevel=function(level){angular.forEach(_pages,function(page){page.currentLevel=page.tileMap.levels[level]})},getNumberOfLevels=function(){return _pages[0].tileMap.levels.length},getPages=function(urn){_pages=[],_pages.updateLevel=updateLevel,_pages.getNumberOfLevels=getNumberOfLevels;var deferred=$q.defer();return $http.get("/tilemap/"+urn).success(function(data){if(data.pages)for(var i=0;i<data.pages.pages.length;i++){var page=data.pages.pages[i];if("COVER_SPINE"===page.pg_type)break;_pages.push({pageId:page.pg_id,pageLabel:page.pg_label,pageType:page.pg_type,resolution:page.resolution,tileHeight:page.tileHeight,tileMap:page.tileMap.image.pyramid}),_pages[i].tileMap.levels=processLevels(_pages[i].tileMap.levels,i)}else deferred.reject("Fant ikke urn: "+urn);deferred.resolve(_pages)}),deferred.promise};return{getPages:getPages}}]),angular.module("search").config(["$stateProvider",function($stateProvider){$stateProvider.state("search",{url:"/search/:query",templateUrl:"modules/search/views/search.client.view.html"})}]),angular.module("search").controller("SearchController",["$rootScope","$scope","$stateParams","$location","Search","ReaderControls","$window",function($rootScope,$scope,$stateParams,$location,Search,ReaderControls,$window){var query=$stateParams.query;$window.document.title="Søkeresultat for "+query,ReaderControls.show=!1,$scope.query=query,$scope.read=function(urn){$location.url("/leser/"+urn)},$scope.error=!1,$scope.searchResults=[];var searchPromise=Search.get(query);searchPromise.then(function(data){if($scope.searchResults.push(data),1===data.entry.length){var urn=data.entry[0]["nb:urn"].$t;$location.url("/leser/"+urn)}},function(error){$rootScope.error=error,$location.url("/")})}]),angular.module("core").factory("Search",["$http","$q",function($http,$q){function refine(data){var coverUrlTemplate="http://www.nb.no/services/image/resolver?url_ver=geneza&maxLevel=5&level=1&col=0&row=0&resX=1649&resY=2655&tileWidth=1024&tileHeight=1024&urn=";Array.isArray(data.entry)!==!0&&(data.entry=[data.entry]);for(var i=0;i<data.entry.length;i++){var entry=data.entry[i];if("undefined"==typeof entry["nb:urn"]||"undefined"==typeof entry["nb:digital"]||"false"===entry["nb:digital"].$t){var removed=data.entry.splice(i,1);console.log("error with data, removing ",removed);break}var urn=entry["nb:urn"].$t;if(entry.cover=coverUrlTemplate+urn+"_C1",-1!==urn.search("; ")){var splitted=urn.split("; ");entry["nb:urn"].$t=splitted[splitted.length-1]}}return data}function get(q,index,limit){currentData=[],deferred=$q.defer(),q=q.replace(/(forfatter|f)[:=]/i,"namecreators:"),q=q.replace(/(år|å)[:=]/i,"year:"),q=q.replace(/(isbn|i)[:=]/i,"isbn:"),q=q.replace(/(beskrivelse|b)[:=]/i,"description:");var ftRegex=/(fritekst|ft)[:=](ja|j)/i;return-1!==q.search(ftRegex)&&(q=q.replace(ftRegex,""),q+="&ft=1"),q=q.replace(/(tittel|titel|titell|t)[:]/i,"title:"),q=q.replace(/[:=&/]$/i,""),index=index||1,limit=limit||50,q+="&index="+index,q+="&items="+limit,$http.get("/search?q="+q).success(function(data){data=data.feed,data.entry?(data=refine(data),currentData=data,deferred.resolve(data)):deferred.reject("Ingen treff.")}).error(function(){deferred.reject("En feil oppstod. Har du avsluttet alle anførselstegn?")}),deferred.promise}var currentData,deferred;return{get:get}}]);