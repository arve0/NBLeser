"use strict";var ApplicationConfiguration=function(){var applicationModuleName="nbleser",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","chieffancypants.loadingBar"],registerModule=function(moduleName){angular.module(moduleName,[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("leser"),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Menus","$anchorScroll","$location","$modal",function($scope,Menus,$anchorScroll,$location,$modal){$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.goto=function(page){$location.hash(page),$anchorScroll()};var modalInstance;$scope.showTerms=function(){modalInstance=$modal.open({templateUrl:"/modules/core/views/terms.client.view.html",scope:$scope})},$scope.closeTerms=function(){modalInstance.close()}}]),angular.module("core").controller("HomeController",["$scope","$location","$rootScope","$http","Search","$modal",function($scope,$location,$rootScope,$http,Search,$modal){var modalInstance;$rootScope.controls={},$rootScope.controls.show=!1,$scope.read=function(urn,close){$location.url("/leser/"+urn),close&&modalInstance.close()},$scope.readFirst=function(query){$scope.error=!1;var searchPromise=Search.get(query);searchPromise.then(function(data){var urn=data.entry[0]["nb:urn"].$t;$location.url("/leser/"+urn)},function(err){$scope.error=err})},$scope.search=function(query){$scope.error=!1,$scope.searchResults=[];var searchPromise=Search.get(query);searchPromise.then(function(data){$scope.searchResults.push(data),modalInstance=$modal.open({size:"lg",templateUrl:"/modules/core/views/search-modal.client.view.html",scope:$scope})},function(error){$scope.error=error})},$scope.closeSearchModal=function(){modalInstance.close()}}]),angular.module("core").service("Menus",function(){this.menus={},this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId){return this.menus[menuId]={items:[]},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemUIRoute){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL}),this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}),angular.module("core").factory("Search",["$http","$q","$sce",function($http,$q){function refine(data){var urlTemplate="http://www.nb.no/services/image/resolver?url_ver=geneza&maxLevel=5&level=1&col=0&row=0&resX=2400&resY=3000&tileWidth=1024&tileHeight=102&urn=";Array.isArray(data.entry)!==!0&&(data.entry=[data.entry]);for(var i=0;i<data.entry.length;i++){var entry=data.entry[i];if("undefined"==typeof entry["nb:urn"]||"undefined"==typeof entry["nb:digital"]||"false"===entry["nb:digital"].$t){var removed=data.entry.splice(i,1);console.log("error with data, removing ",removed);break}var urn=entry["nb:urn"].$t;if(entry.cover=urlTemplate+urn+"_C1",-1!==urn.search("; ")){var splitted=urn.split("; ");entry["nb:urn"].$t=splitted[splitted.length-1]}}return data}function get(q,index,limit){currentData=[],deferred=$q.defer(),q=q.replace(/(forfatter|f)[:=]/i,"namecreators:"),q=q.replace(/(år|å)[:=]/i,"year:"),q=q.replace(/(isbn|i)[:=]/i,"isbn:"),q=q.replace(/(beskrivelse|b)[:=]/i,"description:");var ftRegex=/(fritekst|ft)[:=](ja|j)/i;return-1!==q.search(ftRegex)&&(q=q.replace(ftRegex,""),q+="&ft=1"),q=q.replace(/(tittel|titel|titell|t)[:]/i,"title:"),q=q.replace(/[:=&/]$/i,""),index=index||1,limit=limit||50,q+="&index="+index,q+="&items="+limit,$http.get("/search?q="+q).success(function(data){data=data.feed,data.entry?(data=refine(data),currentData=data,deferred.resolve(data)):deferred.reject("Ingen treff.")}).error(function(){deferred.reject("En feil oppstod. Har du avsluttet alle anførselstegn?")}),deferred.promise}var currentData,deferred;return{get:get}}]),angular.module("leser").config(["$stateProvider",function($stateProvider){$stateProvider.state("/leser",{url:"/leser/:urn",templateUrl:"modules/leser/views/leser.client.view.html"})}]),angular.module("leser").controller("LeserController",["$scope","$rootScope","Tilemap","$document","$stateParams","$location",function($scope,$rootScope,Tilemap,$document,$stateParams,$location){var urn=$stateParams.urn;$rootScope.controls={},$rootScope.controls.show=!0,$rootScope.controls.level=5,$rootScope.controls.zoom=100,$rootScope.controls.zoomValues=[];for(var z=10;100>=z;z+=10)$rootScope.controls.zoomValues.push({value:z,text:z+"%"});$rootScope.$watch("controls.zoom",function(value){$scope.width=function(){return{width:value+"%",height:value+"%"}}}),$scope.scrollTop={},$scope.scrollTop.value=0,$document.on("scroll",function(){$scope.scrollTop.value=(window.pageYOffset||this.scrollTop||0)-(this.clientTop||0),$scope.$digest()}),$scope.show=function(windowPosition,elementPosition){return Math.abs(windowPosition-elementPosition)<5e3};var bookPromise=Tilemap.getPages(urn);bookPromise.then(function(pages){$scope.pages=pages,$rootScope.controls.levels=[];for(var i=0;i<pages.getNumberOfLevels();i++)$rootScope.controls.levels.push(i);$scope.pages.updateLevel($rootScope.controls.level),$rootScope.$watch("controls.level",function(level){$scope.pages.updateLevel(level)})},function(error){$rootScope.error=error,$location.url("/")})}]),angular.module("leser").directive("pageHeight",["$timeout",function($timeout){return{link:function(scope,element){function setHeight(){if(scope.page.currentLevel){var realWidth=element.prop("offsetWidth"),sourceWidth=scope.page.currentLevel.width,zoom=realWidth/sourceWidth,height=Math.ceil(scope.page.currentLevel.height*zoom);element.css("height",height+"px"),scope.page.offsetTop=element.prop("offsetTop")}}scope.$watch("controls.zoom",function(){$timeout(setHeight)})}}}]),angular.module("leser").factory("Tilemap",["$http","$timeout","$q",function($http,$timeout,$q){var _pages,updateLevel=function(level){angular.forEach(_pages,function(page){page.currentLevel=page.tileMap.levels[level]})},getNumberOfLevels=function(){return _pages[0].tileMap.levels.length},getPages=function(urn){_pages=[],_pages.updateLevel=updateLevel,_pages.getNumberOfLevels=getNumberOfLevels;var deferred=$q.defer();return $http.get("/tilemap/"+urn).success(function(data){data.pages?angular.forEach(data.pages.pages,function(page,index){_pages.push({pageId:page.pg_id,pageLabel:page.pg_label,pageType:page.pg_type,resolution:page.resolution,tileHeight:page.tileHeight,tileMap:page.tileMap.image.pyramid}),angular.forEach(_pages[index].tileMap.levels,function(level){var templateUrl=level.uri.template;level.images=[];var pixels,tileHeight=_pages[index].tileMap.tileHeight,tileWidth=_pages[index].tileMap.tileWidth;level.height>tileHeight&&(pixels=level.height-(level.rows-1)*tileHeight,level.lastRowScale=pixels/tileHeight),level.width>tileWidth&&(pixels=level.width-(level.columns-1)*tileWidth,level.lastColumnScale=pixels/tileWidth);for(var i=0;i<level.rows;i++){level.images.push([]);for(var j=0;j<level.columns;j++){var url=templateUrl.replace("{row}",i).replace("{column}",j);level.images[i].push(url)}}})}):deferred.reject("Fant ikke urn: "+urn),deferred.resolve(_pages)}),deferred.promise};return{getPages:getPages}}]);